<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFMI Calculator – Accurate Fat-Free Mass Index (US & Metric)</title>
    <!-- Meta Description (SEO Spec) -->
    <meta name="description" content="FFMI Calculator – Accurate Fat-Free Mass Index (US & Metric). Calculate your FFMI accurately, compare ranges, and track your natural muscle mass potential.">

    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CDN (Spec requirement) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        /* --- GYM / BODYBUILDING THEME (NEON ORANGE/RED & TEXTURED BLACK) --- */
        :root {
            --bs-primary: #FF4500; /* Neon Orange/Red (High Energy Accent) */
            --bs-info: #FFA500; /* Orange secondary highlight */
            --bs-dark-text: #F8F8F8; /* Near-white text for dark background */
            --bs-secondary-text: #B0B0B0; /* Muted secondary text */
            --bs-success: #4CAF50; 
            --bs-warning: #FFC107; 
            --bs-danger: #DC3545;
            --bs-body-bg-color: #0A0A0A; 
            --bs-light-bg: #1A1A1A; /* Section BG */
            --bs-card-bg: #1F1F1F; /* Card BG */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bs-body-bg-color);
            color: var(--bs-dark-text);
            line-height: 1.6;
            min-height: 100vh;
            /* Simulated Textured Background (Subtle diagonal lines on deep black) */
            background-image: linear-gradient(45deg, var(--bs-body-bg-color) 25%, #181818 25%, #181818 50%, var(--bs-body-bg-color) 50%, var(--bs-body-bg-color) 75%, #181818 75%, #181818 100%);
            background-size: 8px 8px; 
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            color: var(--bs-dark-text);
            text-transform: uppercase;
        }
        
        /* General Overrides and Depth Effect */
        .card { 
            background-color: var(--bs-card-bg); 
            border: 1px solid #333; 
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6), inset 0 0 5px rgba(255, 255, 255, 0.08);
        }

        .form-control { 
            background-color: #2D2D2D; 
            border: 1px solid #444; 
            color: var(--bs-dark-text);
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        .form-control::placeholder { color: #f7f4f4; }
        .form-control:focus {
            background-color: #f8f8f8;
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(255, 69, 0, 0.35); /* Neon Orange focus glow */
        }
        .input-group-text {
            background-color: #3A3A3A;
            color: var(--bs-secondary-text);
            border-color: #444;
        }
        .form-check-input:checked {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }
        .form-check-input:focus {
             box-shadow: 0 0 0 0.25rem rgba(255, 69, 0, 0.35);
        }

        /* --- GRADIENT CTA BUTTON (NEON ORANGE) --- */
        .btn-primary {
            /* Aggressive Neon Orange Gradient */
            background: linear-gradient(180deg, var(--bs-primary) 0%, #E63900 100%) !important;
            border: none !important;
            color: #FFF !important; 
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.4); /* Intense glow */
            transition: all 0.2s;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary:hover {
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 10px 30px rgba(255, 69, 0, 0.7);
            filter: brightness(1.1);
        }
        
        /* Outline Button (Action/Copy - Orange Accent) */
        .btn-outline-primary {
             color: var(--bs-primary);
             border-color: var(--bs-primary);
             font-weight: 700;
             transition: all 0.2s;
        }
        .btn-outline-primary:hover {
             background-color: var(--bs-primary) !important;
             color: #FFF !important; 
             box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }


        /* Results Box (FFMI) - Focus on the value */
        .ffmi-result-box {
            background-color: var(--bs-card-bg); 
            border: 2px solid var(--bs-primary); /* Bold orange border */
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.2); /* Stronger orange outer glow */
        }

        /* FFMI Number (Maximum Impact) */
        .result-number {
            font-size: 4.5rem; /* Massive size */
            font-weight: 900; 
            line-height: 1;
            color: var(--bs-primary) !important; 
            text-shadow: 0 0 15px rgba(255, 69, 0, 0.8), 0 0 5px rgba(255, 255, 255, 0.5); /* Intense neon glow */
        }
        
        /* Adjusted FFMI Card (Accent Background) */
        #adjusted-ffmi-card .card {
            background-color: #333333; /* Darker accent card */
            color: var(--bs-dark-text);
            border: 1px solid var(--bs-info);
            box-shadow: 0 4px 10px rgba(255, 165, 0, 0.4);
        }
        #adjusted-ffmi-card .card p, #adjusted-ffmi-card .card small {
            color: var(--bs-dark-text) !important;
        }

        .text-primary { color: var(--bs-primary) !important; }
        .text-secondary-dark { color: var(--bs-secondary-text) !important; }
        .bg-light-section { background-color: var(--bs-light-bg); }
        .navbar { background-color: var(--bs-light-bg) !important; border-bottom: 1px solid #333; }
        
        /* Category Badges */
        .badge { font-weight: 700; padding: 0.5em 0.8em; }
        .bg-danger { background-color: #DC3545 !important; }
        .bg-warning { background-color: #FFC107 !important; color: #121212 !important; } 
        .bg-info { background-color: var(--bs-info) !important; color: #121212 !important; } /* Orange secondary */
        .bg-success { background-color: var(--bs-success) !important; color: #121212 !important; } 
        .bg-primary-badge { background-color: var(--bs-primary) !important; color: #FFF !important; } /* Neon Orange */
        
        .nav-link.active, .navbar-nav .nav-link.active {
            color: var(--bs-primary) !important;
            border-bottom: 2px solid var(--bs-primary);
        }
        .nav-link:hover {
            color: var(--bs-primary) !important;
        }

        /* Chart Styling */
        .chart-container {
            position: relative;
            width: 100%;
            height: 120px; /* Fixed height for the tiny chart */
            margin-top: 1rem;
            padding: 0 10px; /* Spacing for chart labels */
        }
        .chart-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--bs-secondary-text);
            margin-top: 5px;
        }
        .chart-label-category {
            font-weight: 600;
            color: var(--bs-primary);
            text-transform: uppercase;
        }

    </style>
</head>
<body>

    <!-- Header (Sticky) -->
    <header class="sticky-top border-bottom shadow-sm">
        <div class="container py-3">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <a class="navbar-brand fw-bold fs-4 text-primary" href="index.html">FFMI Calculator</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Calculator</a></li>
                        <li class="nav-item"><a class="nav-link" href="how-to-calculate-ffmi.html">How to</a></li>
                        <li class="nav-item"><a class="nav-link" href="ffmi-charrts-ranges.html">Charts</a></li>
                        <li class="nav-item"><a class="nav-link" href="faq.html">FAQ</a></li>
                        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    </ul>
                    <a href="#calculator-section" class="btn btn-primary ms-lg-3 mt-2 mt-lg-0">Start Calculating</a>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <!-- Hero Section & Calculator -->
        <section id="calculator-section" class="py-5 py-md-5 bg-light-section">
            <div class="container" style="max-width: 1140px;">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <h1 class="text-center mb-4 text-uppercase">FFMI Calculator (Fat-Free Mass Index)</h1>
                        <p class="lead text-center text-secondary-dark mb-5">Quickly assess your natural muscle mass potential using the Fat-Free Mass Index (FFMI). **Calculate your potential and fuel your training goals.**</p>

                        <div class="card shadow-lg border-0">
                            <div class="card-body p-4 p-md-5">

                                <!-- Unit Toggle Tabs -->
                                <ul class="nav nav-tabs border-0 mb-4" id="unitTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="us-tab" data-bs-toggle="tab" data-bs-target="#us-inputs" type="button" role="tab" aria-controls="us-inputs" aria-selected="true" data-unit="us">US Units (lb, ft/in)</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="metric-tab" data-bs-toggle="tab" data-bs-target="#metric-inputs" type="button" role="tab" aria-controls="metric-inputs" aria-selected="false" data-unit="metric">Metric Units (kg, cm)</button>
                                    </li>
                                </ul>

                                <form id="ffmi-form" novalidate>
                                    <div class="tab-content" id="unitTabsContent">
                                        
                                        <!-- US Inputs -->
                                        <div class="tab-pane fade show active" id="us-inputs"  role="tabpanel" aria-labelledby="us-tab">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="weight_lb" class="form-label fw-bold">Weight (lb)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="weight_lb" min="50" step="0.1" required aria-describedby="weight_lb_error">
                                                        <span class="input-group-text">lb</span>
                                                    </div>
                                                    <div class="invalid-feedback"  id="weight_lb_error">Please enter a valid weight (e.g., 180).</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-bold">Height (ft/in)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="height_ft" min="3" max="7" required aria-describedby="height_ft_error" placeholder="Feet">
                                                        <span class="input-group-text">ft</span>
                                                        <input type="number" class="form-control" id="height_in" min="0" max="11" required aria-describedby="height_in_error" placeholder="Inches">
                                                        <span class="input-group-text">in</span>
                                                    </div>
                                                    <div class="invalid-feedback" id="height_ft_error">Enter height in feet (e.g., 5) and inches (e.g., 10).</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Metric Inputs -->
                                        <div class="tab-pane fade" id="metric-inputs" role="tabpanel" aria-labelledby="metric-tab">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="weight_kg" class="form-label fw-bold">Weight (kg)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="weight_kg" min="20" step="0.1" required aria-describedby="weight_kg_error">
                                                        <span class="input-group-text">kg</span>
                                                    </div>
                                                    <div class="invalid-feedback" id="weight_kg_error">Please enter a valid weight (e.g., 82).</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="height_cm" class="form-label fw-bold">Height (cm)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="height_cm" min="100" max="230" required aria-describedby="height_cm_error">
                                                        <span class="input-group-text">cm</span>
                                                    </div>
                                                    <div class="invalid-feedback" id="height_cm_error">Please enter a valid height (e.g., 178).</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Common Input: Body Fat % -->
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="body_fat_percent" class="form-label fw-bold">Body Fat (%)</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="body_fat_percent" min="5" max="60" step="0.1" required aria-describedby="body_fat_percent_error">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                                <div class="invalid-feedback" id="body_fat_percent_error">Enter a body fat percentage between 5% and 60%.</div>
                                            </div>
                                            <div class="col-md-6 d-flex align-items-end pt-3 pt-md-0">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="" id="toggle_normalized_ffmi">
                                                    <label class="form-check-label fw-bold" for="toggle_normalized_ffmi">
                                                        Calculate Normalized FFMI
                                                    </label>
                                                    <!-- Tooltip added for explanation -->
                                                    <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" title="The Normalized FFMI adjusts your score to account for height, providing a better comparison baseline.">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill text-info ms-1" viewBox="0 0 16 16">
                                                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34-.34.658-.734.658h-.832c-.394 0-.664-.318-.734-.658l-1-4.705A1.5 1.5 0 0 1 4.75 5h.5a1.5 1.5 0 0 1 1.488 1.39l.352 1.637a.5.5 0 0 0 .964 0l.352-1.637A1.5 1.5 0 0 1 10.75 5h.5a1.5 1.5 0 0 1 1.488 1.39l-.352 1.637a.5.5 0 0 0-.964 0l-.352-1.637a.5.5 0 0 0-.488-.39Z"/>
                                                        </svg>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Buttons -->
                                        <div class="d-flex justify-content-between mt-5">
                                            <button type="submit" class="btn btn-primary btn-lg fw-bold flex-grow-1 me-2" id="calculate-btn" disabled>CALCULATE YOUR POTENTIAL</button>
                                            <button type="button" class="btn btn-outline-primary btn-lg fw-bold" id="reset-btn">Reset</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section (Initially Hidden) -->
                <div class="row justify-content-center mt-5" id="results-container" style="display: none;" role="region" aria-live="polite">
                    <div class="col-lg-10">
                        <h2 class="text-center mb-4 text-primary text-uppercase">Your FFMI Performance</h2>
                        <div class="row g-4">
                            <!-- FFMI Result Card -->
                            <div class="col-md-6">
                                <div class="ffmi-result-box shadow-sm">
                                    <p class="mb-0 fs-6 fw-bold text-secondary-text">Your FFMI (Fat-Free Mass Index)</p>
                                    <p class="result-number mb-2" id="ffmi_display">--.-</p>
                                    <span class="badge rounded-pill fs-6" id="category_badge">Category</span>
                                </div>
                            </div>
                            <!-- Adjusted FFMI Card (Conditional) -->
                            <div class="col-md-6" id="adjusted-ffmi-card" style="display: none;">
                                <div class="card shadow-sm h-100" style="background-color: var(--bs-light-bg); border-color: var(--bs-info);">
                                    <div class="card-body text-center d-flex flex-column justify-content-center">
                                        <p class="mb-0 fs-6 fw-bold">Normalized FFMI (Height-Adjusted)</p>
                                        <p class="result-number mb-2" id="normalized_ffmi_display" style="font-size: 3.8rem; color: var(--bs-info) !important; text-shadow: none;">--.-</p>
                                        <small class="opacity-75 text-secondary-text">Your comparison score against standard potential.</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mini Chart Section -->
                        <div class="card p-4 mt-4 shadow-sm">
                            <h3 class="fs-5 text-primary mb-3">Visual Performance Gauge</h3>
                            <div class="chart-container">
                                <canvas id="ffmiChart"></canvas>
                            </div>
                            <div class="chart-labels">
                                <span class="chart-label-category">BELOW AVG.</span>
                                <span class="chart-label-category">AVERAGE</span>
                                <span class="chart-label-category">EXCELLENT</span>
                                <span class="chart-label-category">ELITE</span>
                            </div>
                        </div>


                        <div class="card p-4 mt-4 shadow-sm">
                            <h3 class="fs-5 text-primary mb-3">Performance Insight</h3>
                            <p id="guidance_text" class="text-secondary-dark"></p>
                            
                            <!-- Quick Actions -->
                            <div class="d-flex flex-wrap gap-2 pt-3 border-top" style="border-color: #333 !important;">
                                <button type="button" class="btn btn-outline-primary btn-sm fw-bold" onclick="copyToClipboard()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/></svg>
                                    Copy Stats
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm fw-bold" onclick="window.print()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0 1h11a.5.5 0 0 0 0-1z"/><path d="M15 5H1a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1M1 6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5H1.5a.5.5 0 0 1-.5-.5z"/><path d="M14 4H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1M2 2a.5.5 0 0 0-.5.5V3a.5.5 0 0 0 .5.5h12a.5.5 0 0 0 .5-.5V2.5a.5.5 0 0 0-.5-.5z"/></svg>
                                    Print Report
                                </button>
                                <!-- PNG/Share URL functionality is complex in single file, placeholder added -->
                                <button type="button" class="btn btn-outline-secondary btn-sm fw-bold" data-bs-toggle="tooltip" data-bs-placement="top" title="Feature pending: Sharing generates URL with parameters.">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M11 2.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0M9.5 6a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M8 7.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0M4.5 9a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M3 10.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0M10.2 11.232C11.535 10.592 13 11.1 14 12c.553.553 1.053 1.107 1.488 1.564.12.126.342.316.634.426.242.08.384.098.468.098h.047a.38.38 0 0 0 .285-.134.383.383 0 0 0-.007-.487c-.361-.41-.758-.887-1.258-1.463-.393-.45-.888-.937-1.488-1.545a.5.5 0 0 1 .49-.877l1.488 1.545c.465.485.875.952 1.258 1.463.14.16.27.324.417.487.094.095.163.134.183.14.07.025.127.037.172.037h.047c.012 0 .025 0 .037-.003.003-.001.006-.002.01-.004.013-.008.026-.016.04-.025.043-.028.086-.06.128-.095.07-.06.136-.134.195-.213.102-.132.193-.27.27-.417.15-.286.27-.61.342-.96.06-.29.07-.492.07-.633a.488.488 0 0 0-.285-.456.495.495 0 0 0-.488.087l-1.488 1.545a.5.5 0 0 1-.774-.633z"/></svg>
                                    Share URL
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast Message for Copy/Error -->
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div id="statusToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body" id="toast-message"></div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Placeholder Content: Methodology Snippet & Disclaimer -->
        <section class="py-5">
            <div class="container" style="max-width: 1140px;">
                <div class="row">
                    <div class="col-md-6 mb-4 mb-md-0">
                        <h2 class="fs-4 fw-bold text-primary text-uppercase">Core Formula & Methodology</h2>
                        <p class="text-secondary-dark">The Fat-Free Mass Index (FFMI) is calculated by first determining **Lean Body Mass (LBM)**, which is total body weight minus fat mass. This LBM (in kilograms) is then divided by the square of your height (in meters). The formula is: $$ FFMI = \frac{\text{LBM (kg)}}{\text{Height (m)}^2} $$ The Adjusted/Normalized FFMI uses an additional calculation to account for variations in height, making it a stronger comparative tool. Consult the <a href="how-to-calculate-ffmi.html" class="text-info text-decoration-none">How To</a> page for the full formulas and citation details.</p>
                    </div>
                    <div class="col-md-6">
                        <h2 class="fs-4 fw-bold text-danger text-uppercase">Educational Disclaimer</h2>
                        <p class="text-secondary-dark">
                            <small>
                                This tool is provided for educational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of a qualified health provider or registered dietitian with any questions you may have regarding a medical condition or body composition assessment. <a href="disclaimer.html" class="text-info text-decoration-none">Read the full disclaimer.</a>
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 border-top" style="background-color: #1A1A1A !important; border-color: #333 !important;">
        <div class="container" style="max-width: 1140px;">
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <h5 class="fw-bold text-primary text-uppercase">FFMI Calculator</h5>
                    <p class="small text-secondary-dark">Accurate body composition assessment based on established anthropometric formulas. Driven by data, built for gains.</p>
                </div>
                <div class="col-6 col-lg-2 mb-3">
                    <h6 class="fw-bold text-primary">Quick Links</h6>
                    <ul class="list-unstyled small">
                        <li><a href="index.html" class="text-secondary-dark text-decoration-none">Calculator</a></li>
                        <li><a href="how-to-calculate-ffmi.html" class="text-secondary-dark text-decoration-none">How to Calculate</a></li>
                        <li><a href="ffmi-charrts-ranges.html" class="text-secondary-dark text-decoration-none">FFMI Ranges</a></li>
                        <li><a href="faq.html" class="text-secondary-dark text-decoration-none">FAQ</a></li>
                    </ul>
                </div>
                <div class="col-6 col-lg-2 mb-3">
                    <h6 class="fw-bold text-primary">Legal</h6>
                    <ul class="list-unstyled small">
                        <li><a href="privacypolicy.html" class="text-secondary-dark text-decoration-none">Privacy Policy</a></li>
                        <li><a href="terms.html" class="text-secondary-dark text-decoration-none">Terms of Use</a></li>
                        <li><a href="disclamier.html" class="text-secondary-dark text-decoration-none">Disclaimer</a></li>
                    </ul>
                </div>
            </div>
            <hr style="border-color: #333;">
            <div class="text-center small text-secondary-dark">
                &copy; 2024 FFMI Calculator. All rights reserved. Prepared for Sultan Akhtar.
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS (required for tabs, tooltips, and toasts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- Chart.js (Optional, using CDN for future Chart implementation) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script>
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        const form = document.getElementById('ffmi-form');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsContainer = document.getElementById('results-container');
        const ffmiDisplay = document.getElementById('ffmi_display');
        const normalizedFfmiDisplay = document.getElementById('normalized_ffmi_display');
        const categoryBadge = document.getElementById('category_badge');
        const guidanceText = document.getElementById('guidance_text');
        const adjustedFfmiCard = document.getElementById('adjusted-ffmi-card');
        const toggleNormalizedFFMI = document.getElementById('toggle_normalized_ffmi');
        const resetBtn = document.getElementById('reset-btn');
        const ffmiChartCanvas = document.getElementById('ffmiChart');
        let ffmiChartInstance = null; // Variable to hold the Chart.js instance

        const FFMI_CATEGORIES = [
            { max: 17, label: "Below Average", color: 'bg-danger', endValue: 17, chartColor: '#DC3545' },
            { max: 19, label: "Average", color: 'bg-warning', endValue: 19, chartColor: '#FFC107' },
            { max: 21, label: "Above Average", color: 'bg-info', endValue: 21, chartColor: '#FFA500' },
            { max: 23, label: "Excellent (trained)", color: 'bg-success', endValue: 23, chartColor: '#4CAF50' },
            { max: Infinity, label: "Exceptional (advanced/elite)", color: 'bg-primary-badge', endValue: 25, chartColor: '#FF4500' } // Capped chart view at 25
        ];

        // --- Helper Functions ---

        /**
         * Utility to display a toast message for feedback (e.g., Copy Success).
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'danger', 'warning', 'info'.
         */
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('statusToast');
            const toastBody = document.getElementById('toast-message');
            
            // Set background color based on type
            let bgColor = '';
            if (type === 'success') bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-success');
            else if (type === 'danger') bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-danger');
            else if (type === 'warning') bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-warning');
            else bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-info');

            toastEl.style.backgroundColor = bgColor;
            toastEl.className = 'toast align-items-center text-white border-0';
            toastBody.textContent = message;
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        /**
         * Copies the FFMI result text to the clipboard.
         */
        function copyToClipboard() {
            const ffmi = ffmiDisplay.textContent;
            const normalizedFfmi = adjustedFfmiCard.style.display !== 'none' ? ` (Adjusted: ${normalizedFfmiDisplay.textContent})` : '';
            const category = categoryBadge.textContent;
            const textToCopy = `FFMI Result: ${ffmi}${normalizedFfmi}. Category: ${category}.`;

            // Use document.execCommand('copy') as navigator.clipboard.writeText() is restricted in some iframes
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast('Stats copied to clipboard!', 'success');
            } catch (err) {
                console.error('Copy failed: ', err);
                showToast('Failed to copy results. Please copy manually.', 'danger');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // --- Chart.js Visualization Logic ---

        function updateChart(ffmiScore) {
            // Destroy previous chart instance if it exists
            if (ffmiChartInstance) {
                ffmiChartInstance.destroy();
            }

            // Define the chart segments and colors
            const segmentData = FFMI_CATEGORIES.map(c => c.endValue).filter(v => v <= 25);
            // Chart.js requires datasets to be an array of values.
            // We use the difference between max values to create the segment widths.
            const dataSegments = [
                segmentData[0] - 5,                                       // Below 17
                segmentData[1] - segmentData[0],                          // 17 to 19
                segmentData[2] - segmentData[1],                          // 19 to 21
                segmentData[3] - segmentData[2],                          // 21 to 23
                25 - segmentData[3]                                       // 23 to 25 (Elite)
            ];
            
            const segmentColors = FFMI_CATEGORIES.filter(c => c.endValue <= 25).map(c => c.chartColor);
            
            // Marker position: Cap the score between 5 (min FFMI shown) and 25 (max FFMI shown)
            const minChartValue = 5;
            const maxChartValue = 25;
            const score = Math.min(Math.max(ffmiScore, minChartValue), maxChartValue);
            const totalRange = maxChartValue - minChartValue;
            
            // Calculate segments for the marker: [value before score, score thickness, value after score]
            const beforeScore = score - minChartValue;
            const markerThickness = 0.5;
            const afterScore = totalRange - beforeScore - markerThickness;

            // Define the marker color (high contrast neon)
            const markerColor = '#FFFFFF';

            // Chart configuration
            ffmiChartInstance = new Chart(ffmiChartCanvas, {
                type: 'bar',
                data: {
                    labels: ['FFMI Range', 'FFMI Score'], // Two dummy labels for the two stacked bars
                    datasets: [
                        // Dataset 1: Range Segments (Background color bar)
                        {
                            label: 'Range',
                            data: dataSegments,
                            backgroundColor: segmentColors,
                            stack: 'stack0',
                            borderWidth: 0,
                            barPercentage: 1, // Make the bar full height
                            categoryPercentage: 1, // Make the bar full height
                        },
                        // Dataset 2: FFMI Pointer (Stacked bars to position the marker)
                        {
                            label: 'Score Pointer',
                            data: [beforeScore, markerThickness, afterScore],
                            backgroundColor: ['rgba(0,0,0,0)', markerColor, 'rgba(0,0,0,0)'],
                            stack: 'stack1',
                            borderWidth: 0,
                            barPercentage: 0.1, // Make the marker thin
                            categoryPercentage: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bar
                    scales: {
                        x: {
                            stacked: true,
                            min: minChartValue,
                            max: maxChartValue,
                            display: false, // Hide the X-axis values
                        },
                        y: {
                            stacked: true,
                            display: false, // Hide the Y-axis labels
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        // Custom plugin to draw the pointer line
                        afterDraw: (chart) => {
                            if (chart.ctx) {
                                const scoreData = chart.data.datasets[1].data;
                                if (scoreData) {
                                    const meta = chart.getDatasetMeta(1);
                                    if (meta && meta.data && meta.data.length > 0) {
                                        const markerElement = meta.data[1];
                                        
                                        // Use canvas coordinates to draw the marker line
                                        const ctx = chart.ctx;
                                        ctx.save();
                                        
                                        // Line starts at the center of the marker element
                                        const xPos = markerElement.x;
                                        const yStart = chart.chartArea.top;
                                        const yEnd = chart.chartArea.bottom;

                                        ctx.beginPath();
                                        ctx.strokeStyle = markerColor;
                                        ctx.lineWidth = 2;
                                        ctx.setLineDash([5, 5]); // Dashed line
                                        ctx.moveTo(xPos, yStart);
                                        ctx.lineTo(xPos, yEnd);
                                        ctx.stroke();

                                        ctx.restore();
                                    }
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    elements: {
                        bar: {
                            borderSkipped: false // Important for full-width bars
                        }
                    }
                }
            });
        }

        // --- Core FFMI Calculation Logic ---

        /**
         * Main function to calculate FFMI and Normalized FFMI based on inputs.
         */
        function calculateFFMI() {
            // Get current active tab to determine unit system
            const activeTab = document.querySelector('#unitTabs .nav-link.active');
            const unitSystem = activeTab ? activeTab.getAttribute('data-unit') : 'us';
            const calculateNormalized = toggleNormalizedFFMI.checked;

            let weight_kg, height_m, body_fat_decimal;

            const bfPercent = parseFloat(document.getElementById('body_fat_percent').value);

            if (isNaN(bfPercent) || bfPercent <= 0 || bfPercent > 100) {
                // Should be caught by validation, but safety first
                return;
            }
            body_fat_decimal = bfPercent / 100;

            if (unitSystem === 'us') {
                const weightLb = parseFloat(document.getElementById('weight_lb').value);
                const heightFt = parseFloat(document.getElementById('height_ft').value);
                const heightIn = parseFloat(document.getElementById('height_in').value);

                if (isNaN(weightLb) || isNaN(heightFt) || isNaN(heightIn)) return;

                // Conversion Formulas (from spec)
                weight_kg = weightLb * 0.45359237;
                height_m = (heightFt * 12 + heightIn) * 0.0254;

            } else { // metric
                const weightKg = parseFloat(document.getElementById('weight_kg').value);
                const heightCm = parseFloat(document.getElementById('height_cm').value);

                if (isNaN(weightKg) || isNaN(heightCm)) return;

                // Conversion Formulas (from spec)
                weight_kg = weightKg;
                height_m = heightCm / 100;
            }

            if (height_m === 0) return;

            // 1. Calculate Lean Mass (LBM) in kg
            const lean_kg = weight_kg * (1 - body_fat_decimal);

            // 2. Calculate FFMI (Fat-Free Mass Index)
            // FFMI = lean_kg / (height_m^2)
            const ffmi = lean_kg / (height_m * height_m);

            // 3. Calculate Normalized FFMI (optional)
            // Normalized FFMI = FFMI + 6.1 × (1.8 − height_m)
            let normalized_ffmi = null;
            if (calculateNormalized) {
                normalized_ffmi = ffmi + (6.1 * (1.8 - height_m));
            }

            displayResults(ffmi, normalized_ffmi);
            updateChart(ffmi); // Update the visual chart
            updateUrlState(unitSystem, weight_kg, height_m, bfPercent, calculateNormalized);
        }

        /**
         * Updates the result display area.
         * @param {number} ffmi - The calculated FFMI.
         * @param {number | null} normalizedFfmi - The calculated Normalized FFMI.
         */
        function displayResults(ffmi, normalizedFfmi) {
            resultsContainer.style.display = 'flex';
            
            // FFMI to 1 decimal (2 on hover - implemented by title attribute)
            const ffmiRounded = ffmi.toFixed(1);
            ffmiDisplay.textContent = ffmiRounded;
            ffmiDisplay.title = ffmi.toFixed(2); // Display 2 decimals on hover

            // Determine Category
            const category = FFMI_CATEGORIES.find(c => ffmi < c.max);
            categoryBadge.textContent = category.label;
            categoryBadge.className = `badge rounded-pill fs-6 ${category.color}`;

            // Update Guidance Text
            guidanceText.innerHTML = `Your FFMI of <strong>${ffmiRounded}</strong> places you in the <strong>${category.label}</strong> range. This is an indicator of your muscle mass relative to your height.`;

            // Handle Normalized FFMI
            if (normalizedFfmi !== null) {
                adjustedFfmiCard.style.display = 'block';
                const normalizedFfmiRounded = normalizedFfmi.toFixed(1);
                normalizedFfmiDisplay.textContent = normalizedFfmiRounded;
                guidanceText.innerHTML += ` Your height-adjusted score is <strong>${normalizedFfmiRounded}</strong>, which is useful for comparing your score to others of different heights.`;
            } else {
                adjustedFfmiCard.style.display = 'none';
            }
        }

        /**
         * Updates the URL hash with current input state for sharing.
         * @param {string} unit - 'us' or 'metric'.
         * @param {number} weightKg - Weight in KG.
         * @param {number} heightM - Height in meters.
         * @param {number} bfPercent - Body Fat percent (5-60).
         * @param {boolean} normalized - Normalized toggle state.
         */
        function updateUrlState(unit, weightKg, heightM, bfPercent, normalized) {
            const params = new URLSearchParams();
            params.set('unit', unit);
            // Store core SI values for universal sharing
            params.set('w', weightKg.toFixed(2));
            params.set('h', heightM.toFixed(3));
            params.set('bf', bfPercent.toFixed(1));
            if (normalized) {
                params.set('norm', '1');
            }
            window.location.hash = params.toString();
        }

        /**
         * Validates the entire form and enables/disables the Calculate button.
         */
        function validateForm() {
            const activePane = document.querySelector('.tab-pane.show.active');
            const inputs = activePane.querySelectorAll('input[required]');
            const bfInput = document.getElementById('body_fat_percent');
            
            let allValid = true;

            // 1. Validate Active Unit Inputs
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                // Check if value is a valid number and within min/max if present
                if (input.value.trim() === '' || isNaN(value) || 
                    (input.min && value < parseFloat(input.min)) ||
                    (input.max && value > parseFloat(input.max))) {
                    input.classList.add('is-invalid');
                    allValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            // 2. Validate Body Fat Input (always present)
            const bfValue = parseFloat(bfInput.value);
            if (bfInput.value.trim() === '' || isNaN(bfValue) || bfValue < 5 || bfValue > 60) {
                bfInput.classList.add('is-invalid');
                allValid = false;
            } else {
                bfInput.classList.remove('is-invalid');
            }
            
            // Enable/Disable Calculate button
            calculateBtn.disabled = !allValid;
        }

        // --- Event Listeners and Initializers ---

        // Real-time Validation Listener (Input/Change/Keyup)
        ['input', 'change', 'keyup'].forEach(event => {
            form.addEventListener(event, (e) => {
                if (e.target.tagName === 'INPUT') {
                    validateForm();
                }
            });
        });

        // Tab Change Listener
        const tabEl = document.getElementById('unitTabs')
        tabEl.addEventListener('shown.bs.tab', function (event) {
            // Re-validate when tabs change, clearing errors on the inactive tab
            const inactivePane = document.querySelector(event.relatedTarget.getAttribute('data-bs-target'));
            inactivePane.querySelectorAll('input').forEach(input => {
                input.classList.remove('is-invalid');
                input.value = ''; // Clear old unit system values
            });
            validateForm();
        });

        // Form Submit Listener (Calculate)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            // This is primarily for button press, but we'll re-validate just in case
            if (!calculateBtn.disabled) {
                calculateFFMI();
            } else {
                showToast('Please correct the invalid inputs before calculating.', 'warning');
            }
        });

        // Reset Button Listener
        resetBtn.addEventListener('click', () => {
            form.reset();
            document.querySelectorAll('input').forEach(input => input.classList.remove('is-invalid'));
            calculateBtn.disabled = true;
            resultsContainer.style.display = 'none';
            window.location.hash = '';
            showToast('Calculator has been reset.', 'info');
            
            if (ffmiChartInstance) {
                ffmiChartInstance.destroy();
                ffmiChartInstance = null;
            }
        });

        // Toggle Listener for Normalized FFMI (re-calculate if results are visible)
        toggleNormalizedFFMI.addEventListener('change', () => {
            if (resultsContainer.style.display !== 'none') {
                calculateFFMI();
            }
        });

        // Initial setup and URL state check on load
        window.addEventListener('load', () => {
            validateForm(); // Initial validation check
            
            // Basic check for URL parameters (FFMI-specific deep linking, simplified)
            if (window.location.hash) {
                const params = new URLSearchParams(window.location.hash.substring(1));
                const unit = params.get('unit');
                const w = parseFloat(params.get('w'));
                const h = parseFloat(params.get('h'));
                const bf = parseFloat(params.get('bf'));
                const norm = params.get('norm');

                // If core SI values are present, calculate and display (even without full form filling)
                if (w && h && bf) {
                    // This section is for deep-linking/sharing results only.
                    toggleNormalizedFFMI.checked = norm === '1';
                    
                    // Simple recalculation from SI units
                    // LBM = W * (1 - BF)
                    const lean_kg = w * (1 - (bf/100));
                    const ffmi = lean_kg / (h * h);
                    let normalized_ffmi = null;
                    if (norm === '1') {
                        normalized_ffmi = ffmi + (6.1 * (1.8 - h));
                    }
                    displayResults(ffmi, normalized_ffmi);
                    updateChart(ffmi);
                    
                    // Optional: Try to fill the form for user editing
                    // This is complex due to unit conversion back, skipping for perfection's sake.
                }
            }
        });

    </script>
</body>
</html>
